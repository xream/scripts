#!name=哪吒探针 本机 Agent
#!desc=将当前设备的信息加入哪吒探针的响应中 https://t.me/zhetengsha
#!category=xream
#!author=@xream https://t.me/zhetengsha
#!arguments=RE_PATTERN:tz\.a\.com,HOSTNAME:tz.a.com,MEDIA:https://avatars.githubusercontent.com/u/105093572,SOUND:1,NAME:HUAWEI P70 Pro,PLATFORM:HarmonyOS,VERSION:4,TAG:Local Device,ID:65535,GEO_API:https://ipservice.ws.126.net/locate/api/getLocByIp,GEO_IP:result.ip,GEO_CODE:result.countrySymbol,MONITOR_NAME:Apple,MONITOR_URL:http://www.apple.com/library/test/success.html,MONITOR_METHOD:HEAD,MONITOR_NUMBER:3,CACHE_S:30,TIMEOUT:5,RETRIES:1,RETRY_DELAY:1
#!arguments-desc=1 为开启, 0 为关闭\n\nRE_PATTERN:\n重写匹配的正则表达式\n\nHOSTNAME:\nMitM 的 Hostname\n\nMEDIA:\n通知的图片(部分 App/系统版本 支持)\n\nSOUND:\n通知是否有声音(部分 App/系统版本 支持)\n\nNAME:\n自定义设备名称\n\nPLATFORM:\n自定义设备平台\n\nVERSION:\n自定义设备平台版本\n\nTAG:\n自定义分组\n\nID:\n自定义设备 ID(不能与原数据中的 ID 重复)\n若修改过, 可能需要刷新数据\n否则打开网络信息时, 可能仍然用的旧的 ID\n\nGEO_API:\n获取 GEO 信息的 API\n\nGEO_IP:\nGEO 信息中 IP 的字段\n\nGEO_CODE:\nGEO 信息中国家代码的字段\n\nMONITOR_NAME:\n测延迟的名称\n\nMONITOR_URL:\n测延迟的 URL\n\nMONITOR_METHOD:\n测延迟的请求方式\n\nMONITOR_NUMBER:\n测延迟的次数\n\nCACHE_S:\n缓存有效期(单位: 秒)\n\nTIMEOUT:\n超时设置(单位: 秒)\n\nRETRIES:\n请求重试次数\n\nRETRY_DELAY:\n请求重试等待时间(单位: 秒)

[Script]
# 由于苹果的安全政策 至少小组件 必须使用 HTTPS 但是我这里先留着这个正则吧
# Request
nezha-agent-request = type=http-request, pattern=^https?:\/\/{{{RE_PATTERN}}}\/api\/v1\/monitor\/{{{ID}}}(\?|$), script-path=https://raw.githubusercontent.com/xream/scripts/main/surge/modules/nezha-agent/nezha-agent.js, requires-body=1, timeout=120, argument="ID={{{ID}}}&MEDIA={{{MEDIA}}}&SOUND={{{SOUND}}}&NAME={{{NAME}}}&PLATFORM={{{PLATFORM}}}&VERSION={{{VERSION}}}&TAG={{{TAG}}}&GEO_API={{{GEO_API}}}&GEO_IP={{{GEO_IP}}}&GEO_CODE={{{GEO_CODE}}}&CACHE_S={{{CACHE_S}}}&TIMEOUT={{{TIMEOUT}}}&RETRIES={{{RETRIES}}}&RETRY_DELAY={{{RETRY_DELAY}}}&MONITOR_NAME={{{MONITOR_NAME}}}&MONITOR_URL={{{MONITOR_URL}}}&MONITOR_METHOD={{{MONITOR_METHOD}}}&MONITOR_NUMBER={{{MONITOR_NUMBER}}}"

# Response
nezha-agent-response = type=http-response, pattern=^https?:\/\/{{{RE_PATTERN}}}\/api\/v1\/server\/details, script-path=https://raw.githubusercontent.com/xream/scripts/main/surge/modules/nezha-agent/nezha-agent.js, requires-body=1, timeout=120, argument="ID={{{ID}}}&MEDIA={{{MEDIA}}}&SOUND={{{SOUND}}}&NAME={{{NAME}}}&PLATFORM={{{PLATFORM}}}&VERSION={{{VERSION}}}&TAG={{{TAG}}}&GEO_API={{{GEO_API}}}&GEO_IP={{{GEO_IP}}}&GEO_CODE={{{GEO_CODE}}}&CACHE_S={{{CACHE_S}}}&TIMEOUT={{{TIMEOUT}}}&RETRIES={{{RETRIES}}}&RETRY_DELAY={{{RETRY_DELAY}}}&MONITOR_NAME={{{MONITOR_NAME}}}&MONITOR_URL={{{MONITOR_URL}}}&MONITOR_METHOD={{{MONITOR_METHOD}}}&MONITOR_NUMBER={{{MONITOR_NUMBER}}}"


[MITM]
hostname = %INSERT% {{{HOSTNAME}}}

